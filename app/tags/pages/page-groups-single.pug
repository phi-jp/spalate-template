page-groups-single(spat-animation='slide')
  div.flex.flex-column.h-full
    module-header(back='{true}', title='{item.data.title}')
    div.h-full.overflow-scroll
      div.container.p10
        div.box-shadow.bg-white.p16.rounded-4.mb16(each='{message in messages}') {message.data.body}
  div.fixed.b0.w-full.bg-white
    form.container.p8.f(onsubmit='{send}', action='')
      input.bg-whitesmoke.w-full.p8.rounded-4.fs13(ref='input', placeholder='Aa')

  style(type='less').
    :scope {
      display: block;
    }

  script.
    this.on('show', async (e) => {
      this.item = await flarestore.db.collection('groups').doc(e.opts.id).getWithRelation();

      this.messages = [];

      this.item.doc.ref.collection('messages').watch(({change, item, isNew}) => {
        this.messages.push(item);
        this.messages.sort((a, b) => {
          return a.data.created_at - b.data.created_at;
        });

        this.update();
      });

      this.update();
    });

    this.send = async (e) => {
      e.preventDefault();

      var value = this.refs.input.value;
      if (!value) return ;

      this.refs.input.value = '';

      var uid = firebase.auth().getUid();
      var messageRef = await this.item.doc.ref.collection('messages').add({
        body: value,
        user_id: uid,
        user_ref: flarestore.db.collection('users').doc(uid),
        created_at: Date.now(),
      });

      this.item.doc.ref.update({
        last_message_id: messageRef.id,
        last_message_ref: messageRef,
        updated_at: Date.now(),
      });

      //- alert(this.refs.input.value);

    };
